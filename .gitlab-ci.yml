cache:
  key: "$CI_JOB_NAME/$CI_COMMIT_REF_NAME"
  untracked: true

stages:
  - build
  - deploy

build:
  stage: build
  script:
    - export HTTP_PROXY=http://proxy.aset.psu.edu:8080
    - export HTTPS_PROXY=http://proxy.aset.psu.edu:8080
    - docker build -t nexus.ci.psu.edu:5000/djb44/random:$CI_COMMIT_SHA .
    - docker push nexus.ci.psu.edu:5000/djb44/random
  tags:
    - docker

deploy:
  stage: deploy
  script:
    - kubectl apply -f random-gif-dev.yml
    - kubectl set image deployment/random-gif-dev random-gif=nexus.ci.psu.edu:5000/djb44/random:$CI_COMMIT_SHA
  only:
    - develop
  environment:
    name: development
    url: https://dev.random-gif.k8s.psu.edu

