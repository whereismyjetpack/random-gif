cache:
  key: "$CI_JOB_NAME/$CI_COMMIT_REF_NAME"
  untracked: true

stages:
  - build
  - deploy

build:
  stage: build
  script:
    - export HTTP_PROXY=http://proxy.aset.psu.edu:8080
    - export HTTPS_PROXY=http://proxy.aset.psu.edu:8080
    - docker build -t nexus.ci.psu.edu:5000/djb44/random:$CI_COMMIT_SHA .
    - docker push nexus.ci.psu.edu:5000/djb44/random
  tags:
    - docker


stop_environment:
  stage: deploy
  variables:
    GIT_STRATEGY: none
  when: manual
  script:
    - helm delete random-gif-$CI_COMMIT_REF_NAME
  environment:
    name: $CI_COMMIT_REF_NAME
    action: stop

deploy_nonprod:
  stage: deploy
  script:
    - helm upgrade --install random-gif-$CI_COMMIT_REF_NAME deploy/random-gif -f values.yml --wait --set image.tag=$CI_COMMIT_SHA --set ingress.hosts={$CI_COMMIT_REF_NAME.random-gif.k8s.psu.edu}
  only:
    - branches
  except:
    - master
  environment:
    name: $CI_COMMIT_REF_NAME
    url: https://$CI_COMMIT_REF_NAME.random-gif.k8s.psu.edu
    on_stop: stop_environment

deploy_prod:
  stage: deploy
  script:
    - helm upgrade --install random-gif-$CI_COMMIT_REF_NAME deploy/random-gif -f values-$CI_COMMIT_REF_NAME.yml --wait --set image.tag=$CI_COMMIT_SHA
  only:
    - master
  environment:
    name: prod
    url: prod.random-gif.k8s.psu.edu
